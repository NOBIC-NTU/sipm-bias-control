# Introduction

The sipm-bias-control repository contains the KiCAD design files for a high dynamic range silicon photomultiplier (SiPM) transimpedance amplifier, power suppply, and bias generator designed by Eben Olson and Michael Giacomelli.  The repository is organized into separate folders for each component, with bias-control containing the design files for the high voltage bias generator, power-supply containing the opamp power supply, and tiav2 containing a high dynamic range transimpedance amplifier using current domain pole zero cancellation.  In addition, the firmware folder contains the firmware required to run the bias-control microcontroller.  

All design files are in KiCAD 5.99/6.0. An [additional ZIP file](https://github.com/OpenSiPM/sipm-bias-control/blob/master/STEP.zip) is provided with .STP 3D models for the board components.  This can be extracted to the root of the repository to insert the STP files into each project.

# bias-control

This PCB is responsible for generating the high voltage (~50V) required to operate a SiPM, receiving USB commands using a SAMD21 microcontroller, and distributing +5v power from USB to the other boards which stack onto it. There are additionally two equivilent programming headers used to initially flash the Arduino bootloader, one for pogo pins and one for conventional push pins.

A list of components required can be viewed online in the interactive [bill of materials](http://htmlpreview.github.io/?https://github.com/OpenSiPM/sipm-bias-control/blob/master/bias-control/kicad/bom/ibom.html).

![Image of bias generator](https://github.com/OpenSiPM/sipm-bias-control/blob/master/bias-control/bias.jpg)

# power-supply

This PCB takes the +5v from USB and converts to low noise +3.3 and -4.5v used by the opamps.  The asymetric voltages are because the negative rail has a much larger impact on dynamic range, making optimization of the negative voltages a lot more important. A list of components required can be viewed online in the interactive [power-supply bill of materials](http://htmlpreview.github.io/?https://github.com/OpenSiPM/sipm-bias-control/blob/master/power-supply/kicad/bom/ibom.html)

![Image of power supply board](https://github.com/OpenSiPM/sipm-bias-control/blob/master/power-supply/psu.jpg)

# tiav2

This PCB receives bias and supply voltages from the other boards and emits amplified RF out over an SMB connector.  An S14420 SiPM is mounted in the center of the PCB, which will mount in an [SM1 lens tube](https://www.thorlabs.com/newgrouppage9.cfm?objectgroup_id=3307) to simplify alignment with an existing microscope.  The transimpedance amplifier implements current domain pole zero cancellation (PZC), where an inductive current divider is used to separate the slow SiPM recharge current from the fast capacitive spike generated by a single photon detection.  Following the divider, a transimpedance amplifier converts to voltage and then drives the 50 ohm SMB connector. An additional offset correction functino is provided using the microcontroller on the bias-control board, enabling either zeroing the amplifier zero point, or shifting the zero point to positive voltages to extend dynamic range.    

The use of current domain PZC has several advantages over conventional methods.  First, since the slow component of the SiPM response is canceled prior to amplification, the dynamic range is extended by the same factor as the PZC attenuates, in this case, 10-fold.  Second, the impedance of the current divider isolates the amplifier from the large capacitance of the SiPM, resulting in higher bandwidth and much greater stability.  Finally, this design is very simple, requiring only one opamp.  

[tiav2 bill of materials](http://htmlpreview.github.io/?https://github.com/OpenSiPM/sipm-bias-control/blob/master/tiav2/kicad/bom/ibom.html)

![Image of TIA board](https://github.com/OpenSiPM/sipm-bias-control/blob/master/tiav2/tia.jpg)

# firmware

The firmware folder includes both the Arudino bootloader for the SAMD21 microcontroller and a basic program for controlling the bias and offset voltages.  See [firmware setup instructions](https://github.com/OpenSiPM/sipm-bias-control/wiki/Setting-up-development-tools-and-flashing-firmware).  

The actual firmware commands are sent over the virtual com port to the microcontroller.  "On" turns on the bias generator.  "Off" turns it off.  "gain 1000" sets the gain to 1000".  "gain?" returns the current gain.  "offset 150" sets the tia offset to 150 units.  

# optical design

Sample Zemax optical design files are provided in the optics demonstrating one possible configuration for illuminating the SiPM detector in a conventional two photon or confocal microscope. 
